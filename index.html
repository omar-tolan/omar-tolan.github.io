<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <label class="col-lg-6 col-xs-12  input-lg">Enter number of visitors</label>
                <select class="col-lg-6 col-xs-12  input-lg" id="dropdwn" class="col-md-6">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option> 
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                    <option>9</option>
                    <option>10</option>
                </select>
            </div>
            <div class="row">
                <select class="col-lg-6 col-xs-12 input-lg" id="reservationType" required>
                    <option>Beach Seating</option>
                    <option>Fofa's Restaurant</option>
                    <option>The Mind Space</option>
                </select>
                <input class="col-lg-6 col-xs-12  input-lg" type="date" id="visit-date" name="visit-date" required>
            </div>
            <div id="form"></div>
            <div class="row" id="qr-code"></div>
            <div id="formEntry" class="row mx-auto">
                <button class="btn-primary  input-lg" type="submit" id="generateCode">Generate QR Code</button>
                <button class="btn  input-lg" id="downloadBtn" disabled>Download QR Code</button>
            </div>
        </div>
       
    </body>
    <script>
        const downloadBtn = document.getElementById("downloadBtn");
        const dropDown = document.getElementById("dropdwn")
        const reservationDropDown = document.getElementById('reservationType')
        const date = document.getElementById("visit-date")
        const form = document.getElementById("form")
        const submitBtn = document.getElementById("generateCode")
        const nameLabel = document.createElement('label')
        const nameInput = document.createElement('input')
        const qrCode = document.getElementById('qr-code');

        const guestList = []
        const guestData = []
        var visitorsNo = 0
        
        dropDown.addEventListener('change', () => {
            form.innerHTML = ''
            visitorsNo = dropDown.value

            nameLabel.textContent = 'Reservation Data';
            nameLabel.className = "col-lg-6 col-xs-12  input-lg"
        
            nameInput.name = `data`;
            nameInput.id = `data`;
            nameInput.placeholder = `Paste Reservation Data`;
            nameInput.className = "col-lg-6 col-xs-12  input-lg"
            
            form.appendChild(nameLabel)
            form.appendChild(nameInput)
        })
        

        submitBtn.addEventListener('click', () => {
            qrCode.innerHTML = ""
            reservationType = reservationDropDown.value
            reservationDate = date.value
            data = nameInput.value.replace(/[\s\n]+/g, "") + "~"
            let guest = {}
            let qrString = ""
            for (let i = 0; i < data.length; i++) {
                if(data[i] == '~'){break}
                let name = ""
                if(data[i] == 'e' && data[i+1] == ':'){
                    let j = i + 2
                    while(data.slice(j, j+6) != "Number"){
                        name = name + data[j]
                        j++;
                    }
                    if(name!=""){
                        guest.name = name
                        console.log(guest.name)
                    }
                    continue
                }
                if(data[i] == 'r' && data[i+1] == ':'){
                    let j = i + 2
                    let number = ""
                    while(data.slice(j, j+6) != "Social"){
                        number = number + data[j]
                        j++;
                    }
                    if(number!=""){
                        guest.number = number
                        console.log(guest.number)
                    }
                    continue
                }
                if(data[i] == 'k' && data[i+1] == ':'){
                    let j = i + 2
                    let link = ""
                    while(data.slice(j, j+4) != "Name"){
                        if(data[j] == '~'){break}
                        link = link + data[j]
                        j++;
                    }
                    if(link!=""){
                        guest.link = link
                        console.log(guest.link)
                        guestList.push(guest)
                        guest = {}
                    }
                    continue
                }
            }
            if(guestList.length != visitorsNo){
                //console.log("Incomplete data expected " + visitorsNo + " guests but got " + guestList.length)
                //return;
            }
            qrCode.innerHTML = ""
            qrString = qrString + "Reservation Type: " + reservationType + " | Number of Guests: " + visitorsNo + " | Reservation Date: " + reservationDate + " | Guests List: "
            
            guestList.forEach(guest => {
                qrString = qrString + guest.name + "__"
            });
            console.log(qrString)
            const qrUrl = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${qrString}`;
            qrCode.innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
            downloadBtn.disabled = false;
            /*
            qrCode.innerHTML = ''
            reservationType = reservationDropDown.value
            reservationDate = date.value
            for(let i = 1; i <= visitorsNo; i++){
                const guestName = document.getElementById(`visitor-${i}`).value;
                guestList.push(guestName);
            }
            var data = "reservation type: " + reservationType + "Guests Number: " + visitorsNo + "\nGuests: "
            guestList.forEach(guest => {
                data = data + guest + " ";
            });
            data = data + "\n reservation date: " + reservationDate
            const jsonData = {
                reservationType,for
                guestList,
                visitorsNo,
                reservationDate
            };
            console.log(data)
            const jsonString = JSON.stringify(jsonData);
            const qrUrl = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${data}`;

            qrCode.innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
            downloadBtn.disabled = false;
            */
        })

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'qr-code.png';

            
            link.href = qrCode.querySelector('img').src;
            link.click();
        })

    </script>
</html>